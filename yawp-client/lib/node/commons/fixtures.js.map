{"version":3,"sources":["../../../src/commons/fixtures.js"],"names":[],"mappings":"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","file":"fixtures.js","sourcesContent":["import { extend } from './utils';\n\nconst DEFAULT_BASE_URL = '/fixtures';\nconst DEFAULT_RESET_URL = '/_ah/yawp/datastore/delete_all';\nconst DEFAULT_LAZY_PROPERTIES = ['id']; // needed till harmony proxies\n\nexport default (request) => {\n\n    class Fixtures {\n        constructor() {\n            this._baseUrl = DEFAULT_BASE_URL;\n            this._resetUrl = DEFAULT_RESET_URL;\n            this._lazyProperties = DEFAULT_LAZY_PROPERTIES;\n            this.promise = null;\n            this.fixtures = [];\n            this.lazy = {};\n        }\n\n        config(callback) {\n            callback(this);\n        }\n\n        baseUrl(url) {\n            this._baseUrl = url;\n        }\n\n        resetUrl(url) {\n            this._resetUrl = url;\n        }\n\n        lazyProperties(properties) {\n            this._lazyProperties = properties;\n        }\n\n        reset(all) {\n            return request(this._resetUrl, {\n                method: 'GET'\n            }).then(() => {\n                this.clear(all);\n            });\n        }\n\n        clear(all) {\n            this.promise = null;\n            for (let i = 0, l = this.fixtures.length; i < l; i++) {\n                var name = this.fixtures[i].name;\n                var path = this.fixtures[i].path;\n                this.bindFixture(name, path);\n                all && this.bindLazy(name, path);\n            }\n        }\n\n        bind(name, path) {\n            this.fixtures.push({name, path});\n            this.bindFixture(name, path);\n            this.bindLazy(name);\n        }\n\n        bindFixture(name, path) {\n            this[name] = new Fixture(this, name, path).api;\n        }\n\n        bindLazy(name) {\n            this.lazy[name] = new Lazy(this, name).api;\n        }\n\n        chain(promiseFn) {\n            if (!this.promise) {\n                this.promise = promiseFn();\n            } else {\n                this.promise = this.promise.then(promiseFn)\n            }\n            return this.promise;\n        }\n\n        load(callback) {\n            if (!this.promise) {\n                return new Promise(() => callback && callback());\n            }\n            return this.promise.then(() => callback && callback());\n        }\n    }\n\n    class Fixture {\n        constructor(fx, name, path) {\n            this.fx = fx;\n            this.name = name;\n            this.path = path;\n            this.api = this.createApi();\n        }\n\n        createApi() {\n            var api = (key, data) => {\n                return this.fx.chain(this.load(key, data));\n            };\n            api.self = this;\n            return api;\n        }\n\n        url() {\n            return this.fx._baseUrl + this.path;\n        }\n\n        load(key, data) {\n            this.createStubs(key);\n            return this.createLoadPromiseFn(key, data);\n        }\n\n        createLoadPromiseFn(key, data) {\n            if (!data) {\n                data = this.getLazyDataFor(key);\n            }\n\n            return () => {\n                if (this.isLoaded(key)) {\n                    return this.api[key];\n                }\n\n                return this.prepare(data).then((object) => {\n                    return request(this.url(), {\n                        method: 'POST',\n                        json: true,\n                        body: JSON.stringify(object)\n                    }).then((response) => {\n                        this.api[key] = response;\n                        return response;\n\n                    })\n                });\n            }\n        }\n\n        getLazyDataFor(key) {\n            var lazy = this.fx.lazy[this.name].self;\n            return lazy.getData(key);\n        }\n\n        prepare(data) {\n            return new Promise((resolve) => {\n                let object = {};\n                extend(object, data);\n\n                let lazyProperties = [];\n                this.inspectLazyProperties(object, lazyProperties);\n                this.resolveLazyProperties(object, lazyProperties, resolve);\n            });\n        }\n\n        resolveLazyProperties(object, lazyProperties, resolve) {\n            if (!lazyProperties.length) {\n                resolve(object);\n            } else {\n                var promise = lazyProperties[0]();\n                for (var i = 1, l = lazyProperties.length; i < l; i++) {\n                    promise = promise.then(lazyProperties[i]);\n                }\n\n                promise.then(() => {\n                    resolve(object);\n                });\n            }\n        }\n\n        inspectLazyProperties(object, lazyProperties) {\n            for (let key in object) {\n                if (!object.hasOwnProperty(key)) {\n                    continue;\n                }\n\n                let value = object[key];\n                if (value instanceof Function) {\n                    lazyProperties.push(() => {\n                        return value().then((actualValue) => {\n                            object[key] = actualValue;\n                        });\n                    });\n                    continue;\n                }\n                if (value instanceof Object) {\n                    this.inspectLazyProperties(value, lazyProperties);\n                    return;\n                }\n            }\n        }\n\n        createStubs(key) {\n            if (this.hasStubs(key)) {\n                return;\n            }\n            let self = this;\n            this.api[key] = this.fx._lazyProperties.reduce((map, property) => {\n                map[property] = () => {\n                    return new Promise((resolve) => resolve(self.api[key][property]));\n                }\n                return map;\n            }, {});\n            this.api[key].__stub__ = true;\n        }\n\n        isLoaded(key) {\n            return this.api[key] && !this.hasStubs(key);\n        }\n\n        hasStubs(key) {\n            return this.api[key] && this.api[key].__stub__;\n        }\n    }\n\n    class Lazy {\n        constructor(fx, name) {\n            this.fx = fx;\n            this.name = name;\n            this.data = {};\n            this.api = this.createApi();\n        }\n\n        createApi() {\n            let api = (key, data) => {\n                this.createLazyStubs(key);\n                this.data[key] = data;\n            };\n            api.self = this;\n            return api;\n        }\n\n        getData(key) {\n            return this.data[key];\n        }\n\n        createLazyStubs(key) {\n            if (this.hasStubs(key)) {\n                return;\n            }\n            this.api[key] = this.fx._lazyProperties.reduce((map, property) => {\n                map[property] = () => {\n                    return this.getFixtureRef().load(key)().then((object) => object[property]);\n                };\n                return map;\n            }, {});\n            this.api[key].__stub__ = true;\n        }\n\n        hasStubs(key) {\n            return this.api[key] && this.api[key].__stub__;\n        }\n\n        getFixtureRef() {\n            return this.fx[this.name].self;\n        }\n    }\n\n    return new Fixtures();\n}\n"]}